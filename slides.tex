\documentclass[handout]{beamer}
\usepackage{fontspec}
\usepackage{minted}
\usepackage{tango}
\usepackage{ccicons}

\mode<presentation>{\usetheme{Copenhagen}}
\title{Using static typing features for fun and profit}
\author{Marek~Kubica}
\date{6.~August~2013}
\institute{Lambda Munich}

\setsansfont{Yanone Kaffeesatz Regular}
\setmainfont{EB Garamond}
\setmonofont[Scale=0.8]{Droid Sans Mono Dotted}

\usemintedstyle{tango}
\usecolortheme{rwo}
\setbeamerfont{title}{family=\rmfamily}
%\setbeamertemplate{blocks}[rounded=false]
%\useinnertheme{default}
\setbeamertemplate{title page}[default][colsep=-0bp,rounded=false,shadow=\beamer@themerounded@shadow]

%% get rid of navigation symbols
%\setbeamertemplate{navigation symbols}{}
\beamertemplatenavigationsymbolsempty

\renewcommand{\example}[1]{{\usebeamercolor[fg]{example text} #1}}

\begin{document}

%\frame{\titlepage
%\ccby
%}

\frame{
  \titlepage
  \vfill
  \begin{center}
    \ccby{}\\[0.5ex]
    {\tiny This work is licensed under a
    \href{http://creativecommons.org/licenses/by/3.0/deed.en_US}%
    {Creative Commons Attribution 3.0 Unported License}.}
    \vspace*{-2.5ex}
  \end{center}
}


\begin{frame}{Some words upfront}
  \begin{alertblock}{Disclaimer}
    I am not a professional OCaml programmer, type theoretician etc.
  \end{alertblock}
  \pause
  \begin{alertblock}{Static typing?}
    I am neither a static typing weenie, I like dynamically typed languages
    too, so put your flamewar away (for now).
  \end{alertblock}
\end{frame}

\begin{frame}[fragile]{Static typing the C way}
  Let's check how C handles look like. How about checking libarchive.
  \begin{minted}[gobble=4]{c}
    __LA_DECL struct archive* archive_read_new(void);
    __LA_DECL struct archive* archive_write_new(void);
  \end{minted}
  \begin{itemize}
    \item Opaque pointer to some struct
    \item Write handles and read handles have the same type
  \end{itemize}
\end{frame}

\begin{frame}
  So, what can we do with these handles?
  \pause
  \begin{itemize}
    \item Create them
    \item Open them
    \item Read from them
    \item Write from them
    \item Close them
  \end{itemize}
  \pause
  Cool.
  \pause
  \alert{But what if we screw up?}
\end{frame}

\begin{frame}[fragile]{Segfault}
  \begin{minted}[gobble=4]{text}
    zsh: segmentation fault (core dumped)  ./errors
  \end{minted}
\end{frame}

\begin{frame}[fragile]{Double free}
\begin{minted}[fontsize=\tiny]{text}
*** Error in `./errors': double free or corruption (fasttop): 0x000000000077a010 ***
======= Backtrace: =========
/usr/lib/libc.so.6(+0x788ae)[0x7fa0c97cd8ae]
/usr/lib/libc.so.6(+0x79587)[0x7fa0c97ce587]
./errors[0x40057b]
/usr/lib/libc.so.6(__libc_start_main+0xf5)[0x7fa0c9776a15]
./errors[0x400479]
======= Memory map: ========
00400000-00401000 r-xp 00000000 fe:01 21244012                           /home/marek/lambda-munich/errors
00600000-00601000 rw-p 00000000 fe:01 21244012                           /home/marek/lambda-munich/errors
0077a000-0079b000 rw-p 00000000 00:00 0                                  [heap]
7fa0c953f000-7fa0c9554000 r-xp 00000000 fe:00 4213606                    /usr/lib/libgcc_s.so.1
7fa0c9554000-7fa0c9754000 ---p 00015000 fe:00 4213606                    /usr/lib/libgcc_s.so.1
7fa0c9754000-7fa0c9755000 rw-p 00015000 fe:00 4213606                    /usr/lib/libgcc_s.so.1
7fa0c9755000-7fa0c98f8000 r-xp 00000000 fe:00 4202529                    /usr/lib/libc-2.17.so
7fa0c98f8000-7fa0c9af8000 ---p 001a3000 fe:00 4202529                    /usr/lib/libc-2.17.so
7fa0c9af8000-7fa0c9afc000 r--p 001a3000 fe:00 4202529                    /usr/lib/libc-2.17.so
7fa0c9afc000-7fa0c9afe000 rw-p 001a7000 fe:00 4202529                    /usr/lib/libc-2.17.so
7fa0c9afe000-7fa0c9b02000 rw-p 00000000 00:00 0 
7fa0c9b02000-7fa0c9b23000 r-xp 00000000 fe:00 4203728                    /usr/lib/ld-2.17.so
7fa0c9cfa000-7fa0c9cfd000 rw-p 00000000 00:00 0 
7fa0c9d22000-7fa0c9d23000 rw-p 00000000 00:00 0 
7fa0c9d23000-7fa0c9d24000 r--p 00021000 fe:00 4203728                    /usr/lib/ld-2.17.so
7fa0c9d24000-7fa0c9d25000 rw-p 00022000 fe:00 4203728                    /usr/lib/ld-2.17.so
7fa0c9d25000-7fa0c9d26000 rw-p 00000000 00:00 0 
7fff44461000-7fff44482000 rw-p 00000000 00:00 0                          [stack]
7fff445fe000-7fff44600000 r-xp 00000000 00:00 0                          [vdso]
ffffffffff600000-ffffffffff601000 r-xp 00000000 00:00 0                  [vsyscall]
zsh: abort (core dumped)  ./errors foo
\end{minted}
\end{frame}

\begin{frame}
  What actually happens: libarchive returns \texttt{ARCHIVE\_FATAL}.\pause

  Unless you trigger a bug in libarchive. \pause
  \alert{Then it segfaults.}
\end{frame}

\begin{frame}{Lots of things can go wrong}
  \begin{itemize}
    \item Reading from handle that is not open *
    \item Writing to a read handle
    \item Not setting the options correctly (compression formats)
  \end{itemize}
  \pause
  * this actually happened
\end{frame}

\begin{frame}{Not to gripe on libarchive}
  \begin{exampleblock}{Public Service Announcement}
    libarchive is a rather well designed library. Rather idiomatic C, so don't
    think this is a deliberately bad example. It is how things are in C land.
  \end{exampleblock}

  \begin{itemize}
    \item This is an OK API for C.
    \item Fragile APIs are common in C.
  \end{itemize}

  \vspace{2ex}
  \pause
  \begin{center}
    {\Large But can we do better?}
  \end{center}
\end{frame}

\begin{frame}
  \begin{center}
    {\Huge \example{Yes}}\\
    \pause
    {\scriptsize (obviously)}
  \end{center}
\end{frame}

\end{document}
